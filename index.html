let text = document.getElementById("text");

let energy = 0;
let tapTimes = [];
let holdStart = null;
let lastTouch = Date.now();

// MEMORY
let visits = parseInt(localStorage.getItem("visits")) || 0;
let totalTouches = parseInt(localStorage.getItem("touches")) || 0;
let maxEnergy = parseInt(localStorage.getItem("maxEnergy")) || 0;
let phase = parseInt(localStorage.getItem("phase")) || 1;
let streak = parseInt(localStorage.getItem("streak")) || 0;
let lastVisit = localStorage.getItem("lastVisit");

visits++;

let today = new Date().toDateString();
if (lastVisit !== today) {
  streak++;
  localStorage.setItem("streak", streak);
}
localStorage.setItem("lastVisit", today);
localStorage.setItem("visits", visits);

function saveMemory() {
  localStorage.setItem("touches", totalTouches);
  localStorage.setItem("maxEnergy", maxEnergy);
  localStorage.setItem("phase", phase);
}

function random(arr) {
  return arr[Math.floor(Math.random() * arr.length)];
}

function show(msg) {
  text.style.opacity = 0;
  setTimeout(() => {
    text.innerText = msg;
    text.style.opacity = 1;
  }, 200);
}

// TIME OF DAY PERSONALITY
function timeMood() {
  let hour = new Date().getHours();
  if (hour >= 0 && hour < 6) return "You shouldn't be here this late.";
  if (hour >= 6 && hour < 12) return "Morning activity detected.";
  if (hour >= 12 && hour < 18) return "Daylight energy stable.";
  return "Night amplifies signals.";
}

// TAP START
document.addEventListener("touchstart", () => {
  energy++;
  totalTouches++;
  tapTimes.push(Date.now());
  holdStart = Date.now();
  lastTouch = Date.now();

  if (energy > maxEnergy) maxEnergy = energy;

  // SECRET RAPID TAP UNLOCK
  if (tapTimes.length > 6) {
    tapTimes.shift();
    let speed = tapTimes[tapTimes.length - 1] - tapTimes[0];
    if (speed < 1200 && phase < 4) {
      phase = 4;
      show("Rapid input override detected.");
    }
  }

  saveMemory();
});

// HOLD DETECTION
document.addEventListener("touchend", () => {
  if (!holdStart) return;
  let holdTime = Date.now() - holdStart;

  if (holdTime > 2000) {
    show("Sustained contact acknowledged.");
    energy += 3;
  }

  holdStart = null;
});

// ENERGY DECAY
setInterval(() => {
  if (energy > 0) energy--;
}, 2500);

// MAIN LOOP
setInterval(() => {

  let idle = Date.now() - lastTouch;

  if (idle > 15000) {
    show("You abandoned the signal.");
    return;
  }

  // PHASE EVOLUTION
  if (totalTouches > 50 && phase === 1) {
    phase = 2;
    show("Behavior shift detected.");
  }

  if (maxEnergy > 15 && phase === 2) {
    phase = 3;
    show("Containment unstable.");
  }

  if (streak > 3 && phase === 3) {
    show("You keep returning. Pattern forming.");
  }

  saveMemory();

  // CHAOTIC EVENTS
  if (Math.random() < 0.02) {
    text.innerText = "▒▒▒▒▒▒▒▒▒▒";
    setTimeout(() => text.innerText = "### SIGNAL DISTORTION ###", 200);
    return;
  }

  // BEHAVIOR ANALYSIS
  if (tapTimes.length >= 2) {
    let interval = tapTimes[tapTimes.length - 1] - tapTimes[tapTimes.length - 2];
    if (interval < 200) {
      show("Aggressive input.");
      return;
    }
    if (interval > 1500) {
      show("Hesitation detected.");
      return;
    }
  }

  // DEFAULT RESPONSES
  if (energy < 3) {
    show("Low activity. " + timeMood());
  } else if (energy < 8) {
    show("Energy rising. Streak: " + streak);
  } else {
    show("Overload threshold nearing.");
  }

}, 2500);

// START MESSAGE
setTimeout(() => {
  show("System active. Visits: " + visits);
}, 1000);
